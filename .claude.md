CLAUDE.md  
项目：小小读书郎（xiaoxiao-dushulang）  
场景：本地 Windows + Claude Code + Docker Desktop → 最终部署到 NameHero 共享主机（仅 Node.js + MySQL，无 Redis、无 root、无 Docker）  
权限：dangerously-skip-permissions = true  
作用：让 Claude 每次启动时自动加载本文件，并执行“零交互”本地→共享主机全流程。  
更新时间：2025-07-18  

# Docker 本地调试备忘录（中英对照）

## 1. 术语统一
- image（镜像）  
- container（容器）  
- volume（卷）

## 2. 调试原则
1. **image** 只当模板，不存数据。  
2. **container** 用完即弃（可加 `--rm`）。  
3. **volume** 必须用“具名卷 / 绑定挂载”，禁止匿名卷，防止数据丢失与卷泛滥。

在本地开发时，先把项目文件夹完整地挂进容器里，让容器里的代码和本地文件实时同步。这样，你每次改动功能，其实只是改动了本地文件，容器里的进程会自动检测到变化并热重载，不需要反复重新打包镜像，也不需要删掉容器再重建。只有当 Dockerfile、依赖清单或系统环境发生变动时，才需要重新构建镜像。

## 3. 一键调试命令模板（Node 示例）
```bash
# 绑定挂载宿主目录 ./data → 容器内 /app/data
# 容器退出后自动删除，端口映射 3000

────────────────────────────────────────  
1. 本地一键启动（Windows / Docker Desktop）  
说明：本地完全复刻共享主机环境，保证“本地跑通 = 线上跑通”。  

# 1.1 克隆
git clone https://github.com/YOUR_NAME/xiaodaode.git
cd xiaodaode

# 1.2 拉起 MySQL 8（容器名：xiaodaode-db）
docker run -d --name xiaodaode-db ^
  -e MYSQL_ROOT_PASSWORD=root ^
  -e MYSQL_DATABASE=xiaodaode ^
  -p 3306:3306 mysql:8

# 1.3 安装依赖 & 初始化
npm ci --silent
npx sequelize-cli db:migrate
npx sequelize-cli db:seed:all

# 1.4 启动本地 Node（热重载）
npm run dev
# 浏览器自动打开 http://localhost:3000/reader/daodejing/1

────────────────────────────────────────  
2. 本地 ↔ 共享主机同步脚本  
Claude 每次保存文件 → 自动执行：

claude.code.onSave = [
  "npm run lint:fix",
  "npm run test",
  "npm run build:static",   # 生成 /public/snapshots
  "npm run deploy:shared"   # 见下方
]

────────────────────────────────────────  
3. 部署到 NameHero 共享主机（零交互脚本）  

# 3.0 前提（一次性）
#   - NameHero 已开 Node.js App → 目录 ~/app
#   - cPanel 提供：FTP 端口 21，SSH 端口 22，MySQL 端口 3306

# 3.1 环境变量（本地 .env.shared）
DB_HOST=localhost
DB_USER=YOUR_CPUSER
DB_PASS=YOUR_CPPASS
DB_NAME=YOUR_CPUSER_xiaodaode
ADMIN_PASS=123456
PORT=3000

# 3.2 部署命令（npm run deploy:shared）
"scripts": {
  "deploy:shared": "npm run build && npm run sync && npm run migrate-shared",
  "sync": "rsync -avz --exclude=node_modules --exclude=.git ./ USER@HOST:~/app/",
  "migrate-shared": "ssh USER@HOST 'cd ~/app && npx sequelize-cli db:migrate --env shared'"
}

Claude 自动执行：
rsync → 只上传差异  
Sequelize 远程 migrate → 不会删除线上数据  

────────────────────────────────────────  
4. 共享主机运行时限制 & 对策  

| 限制 | 对策 | Claude 自动化 |
|---|---|---|
| 无 root、无 Docker | 用 rsync + ssh | 已集成 |
| 仅 512 MB RAM | 本地 `npm run build` 后上传 dist | 已集成 |
| 无 Redis | 会话放 MySQL `sessions` 表 | sequelize-cli |
| 端口仅 80/443 | Apache ProxyPass 到 :3000 | `.htaccess` 已生成 |
| CPU 10 % 峰值 | 本地跑测试，保证单进程 < 50 MB | `npm run test:mem` |

────────────────────────────────────────  
5. Claude 专用快捷命令（Windows 终端）  

# 开发
npm run dev          # nodemon app.js
npm run test:watch   # jest --watch
npm run lint:fix     # eslint --fix

# 一键上线
npm run deploy:shared

# 回滚（上一条 commit）
npm run rollback

────────────────────────────────────────  
6. 文件结构 & 关键入口  

xiaodaode/
├ app.js                 # 入口
├ package.json           # 脚本定义
├ .env.example           # 模板
├ .env.shared            # 共享主机专用
├ config/config.js       # sequelize 多环境
├ scripts/
│  ├ migrate-shared.sh   # ssh 调 migrate
│  └ keepalive.js        # cron 每 10 分
├ .htaccess              # Apache proxy
└ CLAUDE.md              # 本文件

────────────────────────────────────────  
7. 故障自愈（Claude 自动检测）  

- 若端口 3000 被占用 → 自动尝试 3001  
- 若 Sequelize 连接失败 → 重试 3 次后打印 `mysql -h ...` 语句  
- 若 rsync 失败 → fallback 到 ftp-deploy  

────────────────────────────────────────  
8. 快速记忆（给 Claude 的提示）  

# 任何目录下执行：
claude run dev      # 本地开发
claude run deploy   # 一键上线共享主机
claude run backup   # mysqldump → ./backup.sql

End of CLAUDE.md