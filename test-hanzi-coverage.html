<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanzi Writer 汉字覆盖率测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .char-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        .char-card.success {
            border-color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }
        .char-card.error {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }
        .char-display {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .char-status {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .hanzi-writer-container {
            width: 100px;
            height: 100px;
            margin: 10px auto;
            border: 1px solid #eee;
        }
        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .progress-bar {
            height: 30px;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">Hanzi Writer 三本经典汉字覆盖率测试</h1>
        
        <!-- 进度显示 -->
        <div class="progress-section">
            <div class="row">
                <div class="col-md-4">
                    <h5>测试进度</h5>
                    <div class="progress">
                        <div class="progress-bar" id="test-progress" style="width: 0%">0%</div>
                    </div>
                    <div class="mt-2">
                        <span id="test-status">准备测试...</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>支持统计</h5>
                    <div class="text-success">✅ 支持: <span id="supported-count">0</span></div>
                    <div class="text-danger">❌ 不支持: <span id="unsupported-count">0</span></div>
                    <div class="text-muted">📊 总计: <span id="total-count">0</span></div>
                </div>
                <div class="col-md-4">
                    <h5>覆盖率</h5>
                    <div class="display-6" id="coverage-rate">0%</div>
                    <div class="text-muted">Hanzi Writer 支持率</div>
                </div>
            </div>
        </div>

        <!-- 控制按钮 -->
        <div class="text-center mb-4">
            <button id="start-test" class="btn btn-primary btn-lg">🔍 开始测试覆盖率</button>
            <button id="test-sample" class="btn btn-info">🎯 测试常用字样例</button>
            <button id="clear-results" class="btn btn-secondary">🗑️ 清除结果</button>
        </div>

        <!-- 经典选择 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>选择要测试的经典</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="test-sanzijing" value="sanzijing" checked>
                            <label class="form-check-label" for="test-sanzijing">三字经 (372字)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="test-dizigui" value="dizigui" checked>
                            <label class="form-check-label" for="test-dizigui">弟子规 (592字)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="test-daodejing" value="daodejing">
                            <label class="form-check-label" for="test-daodejing">道德经 (1050字)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 测试结果 -->
        <div id="test-results">
            <!-- 这里将显示测试结果 -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5.0/dist/hanzi-writer.min.js"></script>
    <script>
        class HanziCoverageTest {
            constructor() {
                this.testData = {
                    supported: new Set(),
                    unsupported: new Set(),
                    tested: new Set()
                };
                this.sampleChars = ['人', '子', '不', '之', '而', '为', '有', '上', '中', '下', '小', '大', '心', '手', '目', '口', '耳', '木', '火', '水'];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateStats();
            }

            setupEventListeners() {
                document.getElementById('start-test').addEventListener('click', () => {
                    this.startFullTest();
                });
                
                document.getElementById('test-sample').addEventListener('click', () => {
                    this.testSampleChars();
                });
                
                document.getElementById('clear-results').addEventListener('click', () => {
                    this.clearResults();
                });
            }

            async startFullTest() {
                const selectedClassics = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                
                if (selectedClassics.length === 0) {
                    alert('请至少选择一个经典进行测试');
                    return;
                }

                this.clearResults();
                document.getElementById('start-test').disabled = true;
                document.getElementById('test-status').textContent = '正在获取汉字数据...';

                try {
                    const allChars = new Set();
                    
                    for (const classic of selectedClassics) {
                        const chars = await this.fetchClassicChars(classic);
                        chars.forEach(char => allChars.add(char));
                    }

                    const charArray = Array.from(allChars);
                    document.getElementById('total-count').textContent = charArray.length;

                    await this.testCharacters(charArray);
                    
                } catch (error) {
                    console.error('测试过程中出错:', error);
                    document.getElementById('test-status').textContent = '测试失败: ' + error.message;
                } finally {
                    document.getElementById('start-test').disabled = false;
                }
            }

            async fetchClassicChars(classic) {
                const response = await fetch(`/data/${classic}.json`);
                if (!response.ok) {
                    throw new Error(`无法获取${classic}数据`);
                }
                
                const data = await response.json();
                const chars = new Set();
                
                data.chapters.forEach(chapter => {
                    chapter.sentences.forEach(sentence => {
                        const sentenceChars = sentence.simp.split('').filter(char => char.match(/[一-龯]/));
                        sentenceChars.forEach(char => chars.add(char));
                    });
                });
                
                return Array.from(chars);
            }

            async testSampleChars() {
                this.clearResults();
                document.getElementById('test-sample').disabled = true;
                document.getElementById('total-count').textContent = this.sampleChars.length;
                
                await this.testCharacters(this.sampleChars);
                
                document.getElementById('test-sample').disabled = false;
            }

            async testCharacters(chars) {
                const total = chars.length;
                let tested = 0;

                for (const char of chars) {
                    if (this.testData.tested.has(char)) {
                        continue; // 跳过已测试的字符
                    }

                    const supported = await this.testSingleCharacter(char);
                    
                    if (supported) {
                        this.testData.supported.add(char);
                        this.addCharacterResult(char, true);
                    } else {
                        this.testData.unsupported.add(char);
                        this.addCharacterResult(char, false);
                    }
                    
                    this.testData.tested.add(char);
                    tested++;
                    
                    const progress = Math.round((tested / total) * 100);
                    this.updateProgress(progress, `测试中... ${tested}/${total}`);
                    this.updateStats();
                    
                    // 添加小延迟避免阻塞UI
                    await this.delay(50);
                }

                this.updateProgress(100, '测试完成！');
            }

            async testSingleCharacter(char) {
                return new Promise((resolve) => {
                    try {
                        const tempDiv = document.createElement('div');
                        tempDiv.style.display = 'none';
                        document.body.appendChild(tempDiv);

                        const writer = HanziWriter.create(tempDiv, char, {
                            width: 100,
                            height: 100,
                            onLoadCharDataSuccess: () => {
                                document.body.removeChild(tempDiv);
                                resolve(true);
                            },
                            onLoadCharDataError: () => {
                                document.body.removeChild(tempDiv);
                                resolve(false);
                            }
                        });
                        
                        // 设置超时，避免无限等待
                        setTimeout(() => {
                            if (document.body.contains(tempDiv)) {
                                document.body.removeChild(tempDiv);
                                resolve(false);
                            }
                        }, 3000);
                        
                    } catch (error) {
                        resolve(false);
                    }
                });
            }

            addCharacterResult(char, supported) {
                const resultsContainer = document.getElementById('test-results');
                
                if (!resultsContainer.querySelector('.char-grid')) {
                    resultsContainer.innerHTML = '<div class="char-grid"></div>';
                }
                
                const grid = resultsContainer.querySelector('.char-grid');
                
                const charCard = document.createElement('div');
                charCard.className = `char-card ${supported ? 'success' : 'error'}`;
                charCard.innerHTML = `
                    <div class="char-display">${char}</div>
                    <div class="char-status">
                        ${supported ? '✅ 支持' : '❌ 不支持'}
                    </div>
                `;
                
                grid.appendChild(charCard);
            }

            updateProgress(percentage, status) {
                const progressBar = document.getElementById('test-progress');
                const statusText = document.getElementById('test-status');
                
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
                statusText.textContent = status;
            }

            updateStats() {
                document.getElementById('supported-count').textContent = this.testData.supported.size;
                document.getElementById('unsupported-count').textContent = this.testData.unsupported.size;
                
                const total = this.testData.supported.size + this.testData.unsupported.size;
                document.getElementById('total-count').textContent = total;
                
                const coverage = total > 0 ? Math.round((this.testData.supported.size / total) * 100) : 0;
                document.getElementById('coverage-rate').textContent = coverage + '%';
            }

            clearResults() {
                document.getElementById('test-results').innerHTML = '';
                this.testData.supported.clear();
                this.testData.unsupported.clear();
                this.testData.tested.clear();
                this.updateProgress(0, '准备测试...');
                this.updateStats();
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // 初始化测试器
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof HanziWriter !== 'undefined') {
                window.hanziTest = new HanziCoverageTest();
            } else {
                document.getElementById('test-status').textContent = 'HanziWriter 未加载';
            }
        });
    </script>
</body>
</html>